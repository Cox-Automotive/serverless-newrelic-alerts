{
  "Resources": {
    "PluginTestNewRelicPolicy": {
      "Type": "Custom::NewRelicPolicy",
      "Properties": {
        "ServiceToken": "arn:aws:test-policy_service_token",
        "policy": {
          "name": "PluginTest TEST",
          "incident_preference": "PER_POLICY"
        }
      }
    },
    "FunctionThrottlesInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Function Throttles",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "displayName": [
                    "plugin-test-test-under-newrelic-mntrng",
                    "plugin-test-test-dummy-lambda"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "ServerlessSample",
          "select_value": "provider.throttles.Maximum",
          "comparison": "above",
          "critical_threshold": {
            "value": 3,
            "duration_minutes": 5,
            "time_function": "all"
          },
          "integration_provider": "LambdaFunction"
        }
      }
    },
    "FunctionErrorsInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Function Errors",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "displayName": [
                    "plugin-test-test-under-newrelic-mntrng",
                    "plugin-test-test-dummy-lambda",
                    "plugin-test-test-test-lambda"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "ServerlessSample",
          "select_value": "provider.errors.Sum",
          "comparison": "above",
          "critical_threshold": {
            "value": 3,
            "duration_minutes": 5,
            "time_function": "all"
          },
          "integration_provider": "LambdaFunction"
        }
      }
    },
    "FunctionDuration1SecInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Function Duration 1 Sec",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "displayName": [
                    "plugin-test-test-under-newrelic-mntrng",
                    "plugin-test-test-dummy-lambda"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "ServerlessSample",
          "select_value": "provider.duration.Maximum",
          "comparison": "above",
          "critical_threshold": {
            "value": 1000,
            "duration_minutes": 5,
            "time_function": "all"
          },
          "integration_provider": "LambdaFunction"
        }
      }
    },
    "ApiGateway4XxErrorsInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Api Gateway 4 XX Errors",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "apiName": [
                    "test-plugin-test"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "ApiGatewaySample",
          "select_value": "provider.4xxError.Sum",
          "comparison": "above",
          "critical_threshold": {
            "value": 3,
            "duration_minutes": 5,
            "time_function": "all"
          }
        }
      }
    },
    "ApiGateway5XxErrorsInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Api Gateway 5 XX Errors",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "apiName": [
                    "test-plugin-test"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "ApiGatewaySample",
          "select_value": "provider.4xxError.Sum",
          "comparison": "above",
          "critical_threshold": {
            "value": 3,
            "duration_minutes": 5,
            "time_function": "all"
          }
        }
      }
    },
    "DlqVisibleMessagesInfrastructureCondition": {
      "Type": "Custom::NewRelicInfrastructureCondition",
      "Properties": {
        "ServiceToken": "arn:aws:test-infrastructure_condition_service_token",
        "policy_id": {
          "Ref": "PluginTestNewRelicPolicy"
        },
        "data": {
          "type": "infra_metric",
          "name": "PluginTest TEST - Dlq Visible Messages",
          "enabled": true,
          "filter": {
            "and": [
              {
                "in": {
                  "queueName": [
                    "test-sqs-dlq"
                  ]
                }
              }
            ]
          },
          "violation_close_timer": 24,
          "policy_id": {
            "Ref": "PluginTestNewRelicPolicy"
          },
          "event_type": "QueueSample",
          "select_value": "provider.approximateNumberOfMessagesVisible.Maximum",
          "comparison": "above",
          "critical_threshold": {
            "value": 3,
            "duration_minutes": 5,
            "time_function": "all"
          },
          "integration_provider": "SqsQueue"
        }
      }
    }
  }
}
